<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Dashboard</title>
    <link rel="icon" type="image/x-icon" href="logo.png">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard-body">

    <nav class="sidebar" aria-label="Main Navigation">
        <div class="logo-container">
            <img src="logo.png" alt="Company Logo" class="logo-img">
            <h2 id="user-display">Welcome</h2>
            <small id="role-display" style="color: #888; text-transform: uppercase; font-size: 0.8em;"></small>
        </div>
        <hr style="border-color: #333; width: 100%;">
        
        <div id="menu-admin-only" class="hidden">
            <p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">SYSTEM ADMIN</p>
            <button type="button" class="menu-btn" onclick="showSection('users')">Manage Users & Roles</button>
        </div>

        <div id="menu-manager-work" class="hidden">
            <p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">PROJECT MANAGEMENT</p>
            <button type="button" class="menu-btn" onclick="showSection('projects')">Projects</button>
            <button type="button" class="menu-btn" onclick="showSection('assign')">Assign Tasks</button>
        </div>
        
        <div id="menu-workspace">
            <p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">WORKSPACE</p>
            <button type="button" class="menu-btn" onclick="showSection('mytasks')">Task Board</button>
        </div>
        
        <button type="button" class="btn-logout" onclick="logout()">Logout</button>
    </nav>

    <main class="main">
        
        <section id="sec-users" class="section hidden">
            <h2>User Management</h2>
            <div class="card">
                <h3>Add New User</h3>
                <form onsubmit="submitForm(event, 'add_user')">
                    <input type="text" name="fullname" placeholder="Full Name" aria-label="Name" required>
                    <input type="text" name="username" placeholder="Username" aria-label="User" required>
                    <input type="password" name="password" placeholder="Password" aria-label="Pass" required>
                    <label>Role:</label>
                    <select name="role" aria-label="Role">
                        <option value="member">Member</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                    <input type="hidden" name="action" value="add_user">
                    <button type="submit" class="btn-primary">Create User</button>
                </form>
            </div>
            
            <div class="card">
                <h3>Existing Users</h3>
                <input type="text" id="userSearch" onkeyup="filterTable('userSearch', 'admin-users-list')" placeholder="Search users..." class="search-bar">
                <table class="data-table">
                    <thead><tr><th>Name</th><th>Role</th><th>Update Role</th><th>Reset Password</th><th>Action</th></tr></thead>
                    <tbody id="admin-users-list"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-projects" class="section hidden">
            <h2>Projects</h2>
            <div class="card">
                <h3>Create New Project</h3>
                <form onsubmit="submitForm(event, 'add_project')">
                    <input type="text" name="title" placeholder="Project Title" aria-label="Title" required>
                    <input type="hidden" name="action" value="add_project">
                    <button type="submit" class="btn-primary">Create Project</button>
                </form>
            </div>
            <div class="card">
                <h3>Active Projects</h3>
                <input type="text" id="projSearch" onkeyup="filterTable('projSearch', 'project-list-table')" placeholder="Search projects..." class="search-bar">
                <table class="data-table">
                    <thead><tr><th>ID</th><th>Title</th><th>Progress</th><th>Action</th></tr></thead>
                    <tbody id="project-list-table"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-assign" class="section hidden">
            <h2>Assign Tasks</h2>
            
            <div class="card">
                <h3>New Assignment</h3>
                <form onsubmit="submitForm(event, 'assign_task')">
                    <label>Project:</label>
                    <select name="project_id" id="project-select" aria-label="Project"></select>
                    <label>Assign To:</label>
                    <select name="user_id" id="user-select" aria-label="User"></select>
                    <input type="text" name="title" placeholder="Task Description" aria-label="Desc" required>
                    <label>Deadline:</label>
                    <input type="date" name="deadline" aria-label="Date" required>
                    <input type="hidden" name="action" value="assign_task">
                    <button type="submit" class="btn-primary">Assign Task</button>
                </form>
            </div>

            <div class="card">
                <h3>Task History Log</h3>
                <input type="text" id="assignSearch" onkeyup="filterTable('assignSearch', 'assign-list-table')" placeholder="Search tasks..." class="search-bar">
                <table class="data-table">
                    <thead><tr><th>Task</th><th>Project</th><th>Assigned To</th><th>Deadline</th><th>Status</th></tr></thead>
                    <tbody id="assign-list-table"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-mytasks" class="section">
            <h2>Overview</h2>
            <div class="stats-container">
                <div class="card chart-card"><canvas id="statusChart"></canvas></div>
                <div class="card summary-card">
                    <h3 style="color: var(--primary-color);">Total Tasks</h3>
                    <p id="total-tasks-count" style="font-size: 3em; font-weight: bold;">0</p>
                </div>
            </div>
            
            <h2>Task Board</h2>
            <div id="task-list">Loading...</div>
        </section>

    </main>

    <script>
        let myChart = null;
        let currentUser = {}; 

        document.addEventListener('DOMContentLoaded', loadDashboard);

        async function loadDashboard() {
            const formData = new FormData();
            formData.append('action', 'get_dashboard_data');
            
            try {
                const res = await fetch('api.php', { method: 'POST', body: formData });
                const data = await res.json();
                if(data.status === 'error') { window.location.href = 'index.html'; return; }

                currentUser = data.current_user;
                
                // UI SETUP
                document.getElementById('user-display').innerText = currentUser.name;
                document.getElementById('role-display').innerText = currentUser.role;

                // TOGGLE SECTIONS
                if (currentUser.role === 'admin') {
                    document.getElementById('menu-admin-only').classList.remove('hidden');
                    renderUserTable(data.users);
                }
                if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                    document.getElementById('menu-manager-work').classList.remove('hidden');
                    populateSelects(data.projects, data.users);
                    renderProjectTable(data.projects);
                    renderAssignTable(data.tasks); 
                }

                // RENDER TASKS & STATS
                renderTasks(data.tasks);
                document.getElementById('total-tasks-count').innerText = data.tasks.length;
                renderChart(data.stats);

            } catch (error) { console.error(error); }
        }

        // --- RENDER TABLES ---

        function renderUserTable(users) {
            const tbody = document.getElementById('admin-users-list');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.full_name}</td>
                    <td>${u.role}</td>
                    <td>
                        <form onsubmit="simpleAction(event, 'update_role', ${u.id})" style="display:flex; gap:5px;">
                            <select name="new_role" style="padding:5px; margin:0;" aria-label="Role">
                                <option value="member">Member</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                            <button type="submit" style="width:auto; margin:0; padding:5px;">Save</button>
                        </form>
                    </td>
                    <td>
                        <form onsubmit="simpleAction(event, 'update_password', ${u.id})" style="display:flex; gap:5px;">
                            <input type="password" name="new_password" placeholder="New Pass" style="margin:0; padding:5px; width:100px;" aria-label="New Pass" required>
                            <button type="submit" style="width:auto; margin:0; padding:5px;">Reset</button>
                        </form>
                    </td>
                    <td>
                        ${currentUser.role === 'admin' ? 
                            `<button onclick="deleteUser(${u.id})" style="background:#e74c3c; color:white; width:auto; padding:5px 10px; margin:0;">Delete</button>` 
                        : ''}
                    </td>
                </tr>
            `).join('');
        }

        function renderProjectTable(projects) {
            const tbody = document.getElementById('project-list-table');
            tbody.innerHTML = projects.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.title}</td>
                    <td>
                        ${currentUser.role === 'admin' ? `
                            <select onchange="updateProjectStatus(${p.id}, this.value)" style="margin:0; padding:5px;">
                                <option value="Pending" ${p.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="In Progress" ${p.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Completed" ${p.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        ` : (p.status || 'Pending')}
                    </td>
                    <td>
                        ${currentUser.role === 'admin' ? 
                            `<button onclick="deleteProject(${p.id})" style="background:#e74c3c; color:white; width:auto; padding:5px 10px; margin:0;">Delete</button>` 
                        : 'View Only'}
                    </td>
                </tr>
            `).join('');
        }

        function renderAssignTable(tasks) {
            const tbody = document.getElementById('assign-list-table');
            const sortedTasks = tasks.slice().sort((a,b) => b.id - a.id);
            tbody.innerHTML = sortedTasks.map(t => `
                <tr>
                    <td>${t.title}</td>
                    <td>${t.project_title}</td>
                    <td>${t.full_name}</td>
                    <td>${t.deadline}</td>
                    <td><span class="status-${t.status.substring(0,3)}">${t.status}</span></td>
                </tr>
            `).join('');
        }

        function populateSelects(projects, users) {
            document.getElementById('project-select').innerHTML = projects.map(p => `<option value="${p.id}">${p.title}</option>`).join('');
            document.getElementById('user-select').innerHTML = users.map(u => `<option value="${u.id}">${u.full_name} (${u.role})</option>`).join('');
        }

        // --- TASKS BOARD LOGIC ---
        function renderTasks(tasks) {
            const list = document.getElementById('task-list');
            if(tasks.length === 0) { list.innerHTML = "<p>No tasks found.</p>"; return; }
            
            list.innerHTML = tasks.map(t => {
                const isAssignee = (t.assigned_to == currentUser.user_id);
                const isManagerOrAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
                const isCompleted = (t.status === 'Completed');
                
                let actionHTML = '';
                if (isAssignee && !isCompleted) {
                    actionHTML = `
                        <form onsubmit="submitTask(event, ${t.id})">
                            <input type="file" name="proof" aria-label="Upload" required>
                            <button type="submit" class="btn-primary">Submit for Review</button>
                        </form>`;
                }
                if (isManagerOrAdmin && !isAssignee && t.status === 'For Review') {
                    actionHTML = `
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button onclick="reviewTask(${t.id}, 'approve')" style="background:#27ae60; color:white;">Approve</button>
                            <button onclick="reviewTask(${t.id}, 'reject')" style="background:#e74c3c; color:white;">Reject</button>
                        </div>
                        <p><small>View Proof: <a href="#">${t.proof_file || 'No file'}</a></small></p>
                    `;
                }
                return `
                <div class="card task-card">
                    <h3>${t.title} <small>(${t.project_title})</small></h3>
                    <p>Assigned to: <strong>${t.full_name}</strong></p>
                    <p>Deadline: ${t.deadline}</p>
                    <p class="status-${t.status.substring(0,3)}">Status: ${t.status}</p>
                    ${actionHTML}
                </div>`;
            }).join('');
        }

        // --- ACTIONS ---

        async function submitForm(e, action) {
            e.preventDefault();
            const formData = new FormData(e.target);
            await fetch('api.php', { method: 'POST', body: formData });
            alert('Success');
            e.target.reset();
            loadDashboard();
        }

        async function simpleAction(e, action, id) {
            e.preventDefault();
            const formData = new FormData(e.target);
            formData.append('action', action);
            formData.append('user_id', id); 
            await fetch('api.php', { method: 'POST', body: formData });
            alert('Updated!');
            e.target.reset();
            loadDashboard();
        }

        async function submitTask(e, taskId) {
            e.preventDefault();
            const formData = new FormData(e.target);
            formData.append('action', 'submit_task');
            formData.append('task_id', taskId);
            await fetch('api.php', { method: 'POST', body: formData });
            alert('Task Submitted!');
            loadDashboard();
        }

        async function reviewTask(taskId, decision) {
            const formData = new FormData();
            formData.append('action', 'review_task');
            formData.append('task_id', taskId);
            formData.append('decision', decision);
            await fetch('api.php', { method: 'POST', body: formData });
            loadDashboard();
        }

        // --- NEW DELETE AND UPDATE FUNCTIONS ---

        async function deleteUser(id) {
            if(!confirm("Are you sure you want to delete this user?")) return;
            const formData = new FormData();
            formData.append('action', 'delete_user');
            formData.append('user_id', id);
            await fetch('api.php', { method: 'POST', body: formData });
            loadDashboard();
        }

        async function deleteProject(id) {
            if(!confirm("Are you sure you want to delete this project?")) return;
            const formData = new FormData();
            formData.append('action', 'delete_project');
            formData.append('project_id', id);
            await fetch('api.php', { method: 'POST', body: formData });
            loadDashboard();
        }

        async function updateProjectStatus(id, newStatus) {
            const formData = new FormData();
            formData.append('action', 'update_project_status');
            formData.append('project_id', id);
            formData.append('status', newStatus);
            await fetch('api.php', { method: 'POST', body: formData });
            // No need to reload whole dashboard, but we can to be safe
            loadDashboard();
        }

        // --- UTILITIES ---

        function filterTable(inputId, tableId) {
            const input = document.getElementById(inputId);
            const filter = input.value.toUpperCase();
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName("tr");
            for (let i = 0; i < tr.length; i++) {
                let rowText = tr[i].innerText || tr[i].textContent;
                if (rowText.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }     
            }
        }

        function renderChart(stats) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'In Progress', 'For Review', 'Completed'],
                    datasets: [{ data: [stats['Pending'], stats['In Progress'], stats['For Review'], stats['Completed']], backgroundColor: ['#f39c12', '#00B4D8', '#9b59b6', '#27ae60'], borderWidth: 0 }]
                }
            });
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById('sec-' + id).classList.remove('hidden');
        }

        function logout() { window.location.href = 'index.html'; }
    </script>
</body>
</html>